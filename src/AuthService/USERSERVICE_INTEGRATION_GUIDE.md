# UserService Implementation Guide

This document provides the expected implementation for UserService to complete the event-driven registration flow.

## Consumer Implementation (UserService Side)

### UserRegisteredConsumer.cs
```csharp
using Auth.Contracts.Events;
using MassTransit;
using Microsoft.Extensions.Logging;
using Users.Contracts.Events;

namespace UserService.Infrastructure.MassTransit.Consumers;

public class UserRegisteredConsumer : IConsumer<UserRegisteredV1>
{
    private readonly IUserRepository _userRepository;
    private readonly IPublishEndpoint _publishEndpoint;
    private readonly ILogger<UserRegisteredConsumer> _logger;

    public UserRegisteredConsumer(
        IUserRepository userRepository,
        IPublishEndpoint publishEndpoint,
        ILogger<UserRegisteredConsumer> logger)
    {
        _userRepository = userRepository;
        _publishEndpoint = publishEndpoint;
        _logger = logger;
    }

    public async Task Consume(ConsumeContext<UserRegisteredV1> context)
    {
        var message = context.Message;

        _logger.LogInformation(
            "Received UserRegisteredV1: AuthUserId={AuthUserId}, Email={Email}",
            message.AuthUserId,
            message.Email);

        // Create user in UserService database
        // UserService generates its own UserId (string)
        var userId = Guid.CreateVersion7().ToString(); // or any ID generation strategy

        var user = new User
        {
            UserId = userId,
            AuthUserId = message.AuthUserId,
            Email = message.Email,
            Roles = message.Roles.ToList(),
            Permissions = message.Permissions.ToList(),
            CreatedAt = DateTime.UtcNow
        };

        await _userRepository.AddAsync(user);
        await _userRepository.SaveChangesAsync(context.CancellationToken);

        _logger.LogInformation(
            "Created user with UserId={UserId} for AuthUserId={AuthUserId}",
            userId,
            message.AuthUserId);

        // Publish UserCreatedV1 back to AuthService
        var integrationEvent = new UserCreatedV1(
            AuthUserId: message.AuthUserId,
            UserId: userId,
            CreatedAt: DateTime.UtcNow);

        await _publishEndpoint.Publish(integrationEvent, context.CancellationToken);

        _logger.LogInformation(
            "Published UserCreatedV1 for UserId={UserId}",
            userId);
    }
}
```

## MassTransit Configuration (UserService)

### Add to DependencyInjection.cs
```csharp
services.AddMassTransit(config =>
{
    // Register the consumer
    config.AddConsumer<UserRegisteredConsumer>();

    config.UsingRabbitMq((context, busConfig) =>
    {
        string connectionString = configuration.GetConnectionString("RabbitMq")!;
        
        busConfig.Host(new Uri(connectionString), h => { });
        
        // Configure the consumer endpoint
        busConfig.ReceiveEndpoint("user-registered-queue", e =>
        {
            e.ConfigureConsumer<UserRegisteredConsumer>(context);
        });
        
        busConfig.ConfigureEndpoints(context);
    });
});
```

## User Entity Example

```csharp
public class User
{
    public string UserId { get; set; } = string.Empty;
    public string AuthUserId { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    public List<string> Roles { get; set; } = new();
    public List<string> Permissions { get; set; } = new();
    public DateTime CreatedAt { get; set; }
    public bool IsActive { get; set; } = true;
}
```

## Testing the Flow

1. **AuthService**: POST /auth/register with email and password
2. **AuthService** creates AuthUser with UserId=null
3. **AuthService** publishes `UserRegisteredV1` to RabbitMQ
4. **UserService** consumes `UserRegisteredV1`
5. **UserService** creates User with generated UserId
6. **UserService** publishes `UserCreatedV1` back to RabbitMQ
7. **AuthService** consumes `UserCreatedV1`
8. **AuthService** links the UserId to AuthUser record

## Expected Message Flow

```
AuthService                    RabbitMQ                    UserService
    |                              |                            |
    |--UserRegisteredV1----------->|                            |
    |                              |--UserRegisteredV1--------->|
    |                              |                            | Create User
    |                              |<----UserCreatedV1----------|
    |<----UserCreatedV1------------|                            |
    | Link UserId                  |                            |
```

## Notes

- AuthUserId is a Guid (as string) generated by AuthService
- UserId is a string generated independently by UserService (can be Guid, int, or any format)
- Both services maintain their own databases
- Communication is fully asynchronous via MassTransit/RabbitMQ
- No direct service-to-service calls
- Services can be deployed and scaled independently
